# 计划任务列表（由 README 拆分）

> 目标：落地 “QCurl ↔ libcurl（含 libtest 工具）数据一致性测试候选集”，采用 **Qt Test（C++）+ pytest（Python）混合** 的方式实现与编排。

| ID | 任务描述 | 优先级 | 依赖关系 | 状态 | 执行日志 |
|---|---|---|---|---|---|
| LC-0 | 明确“一致性”的可观测断言与 `artifacts` 最小字段（下载/上传/WS：status、协议族(h1/h2/h3)、body 长度+hash、关键响应头；**P0 必做：请求语义摘要**（method/url/关键头规范化）+ request body 的 len/hash；不强制记录“服务端看到的原始请求字节”；错误码/超时归一化规则）。 | 高 | 无 | 已完成 | 2025-12-16：已在 README 固化字段，确认请求语义摘要为 P0 必做，不记录服务端原始字节。 |
| LC-1 | 固化候选集清单与边界：把 `README.md` 中 **P0/P1/可选扩展/明确排除** 转成可执行清单（可先用静态列表；如需参数化再引入 manifest）。 | 高 | LC-0 | 已完成 | 2025-12-16：已转成本表，覆盖 P0/P1/扩展/排除清单。 |
| LC-2 | 编写 pytest 驱动骨架：复用 `curl/tests/http/testenv` 启动服务端（http/1.1 + h2 + h3 + ws），提供统一的 “启动/停止/日志收集/端口分配” 封装。 | 高 | LC-0 | 已完成 | 2025-12-16：新增 `tests/libcurl_consistency/conftest.py` 复用 testenv（注入 CURL_BUILD_DIR/CURL/CURLINFO），并生成 `curl/tests/http/config.ini`；新增 `test_env_smoke.py` 验证 httpd/nghttpx/ws 可启动（受 sandbox 限制需 escalated）。<br>2025-12-16 22:50:45：复跑 `pytest tests/libcurl_consistency/test_env_smoke.py` 通过；sandbox 下端口分配触发 `PermissionError`，需 escalated。<br>2025-12-17 00:11:39：修复 curl testenv `httpd.py` 生成配置中 `TypesConfig` 引号缺失，复跑 smoke 通过。<br>2025-12-17 11:22:09：新增 `tests/libcurl_consistency/nghttpx_from_source/`，CMake target `qcurl_nghttpx_h3` 通过 `ExternalProject` 从源码构建并安装 **h3-capable** `nghttpx` 到 `build/libcurl_consistency/nghttpx-h3/`（`--enable-http3`）；`tst_LibcurlConsistency` 依赖该 target；同时将 `curl/tests/http/config.ini` 的 `nghttpx` 指向 build 下路径，使 `env.have_h3()` 覆盖 h3 变体。验证：`build/libcurl_consistency/nghttpx-h3/bin/nghttpx --version` 包含 `ngtcp2/...`。 |
| LC-3 | 在 pytest 中跑 **libcurl baseline**：通过 `LocalClient(name='cli_*')` 调用 `curl/tests/libtest/libtests`，生成 baseline `artifacts`（每条用例一份 JSON）。 | 高 | LC-1、LC-2 | 已完成 | 2025-12-16：完善 `pytest_support/baseline.py`（hash/len、请求语义摘要）；补齐 `case_defs.py` P0 参数模板；新增 `curl/tests/libtest/cli_hx_range_resume.c` 并更新 `curl/tests/libtest/Makefile.inc`，重建 `curl/build/tests/libtest/libtests`。<br>2025-12-16 22:50:45：`cmake --build \"curl/build\" --target libtests` 构建通过。<br>2025-12-16 22:58:27：为“请求语义摘要”补齐可比字段：上传 baseline 用例参数追加 `-l` 强制 Content-Length；Range 续传 baseline 支持 `-S` 并用 `CURLOPT_RANGE` 显式 end，已重建 `libtests` 并复跑 P0 通过。 |
| LC-4 | 新增 Qt Test（C++）：实现与 P0/P1 对齐的 QCurl 客户端场景（下载/上传/WS），将结果写出为 QCurl `artifacts`（JSON，字段与 LC-0 一致）。 | 高 | LC-0、LC-2 | 已完成 | 2025-12-16：新增 `tests/tst_LibcurlConsistency.cpp`（按 env vars 执行单用例并落盘 download_*.data），并在 `tests/CMakeLists.txt` 注册生成 `build/tests/tst_LibcurlConsistency`；`pytest_support/qcurl_runner.py` 负责运行与写出 QCurl artifacts。<br>2025-12-16 22:50:45：`cmake --build \"build\" --target tst_LibcurlConsistency` 构建通过。 |
| LC-5 | 实现对比器（pytest 侧）：读取 baseline/QCurl `artifacts`，做字节级（hash/len）与关键语义字段对比（**P0 必做：请求语义摘要一致性**），输出可机器消费的报告（JSON/JUnit 二选一或同时）。 | 高 | LC-0、LC-3、LC-4 | 已完成 | 2025-12-16：新增 `pytest_support/compare.py`（compare + assert helper），并在 `test_p0_consistency.py` 接线执行。<br>2025-12-16 22:50:45：`QCURL_QTTEST=\"build/tests/tst_LibcurlConsistency\" pytest tests/libcurl_consistency/test_p0_consistency.py` 通过（7 passed）；artifacts 输出在 `curl/tests/http/gen/artifacts/`（sandbox 下需 escalated 启动服务端）。 |
| LC-5a | P0 Gate 可靠性：将“请求语义摘要”从“构造值”升级为“观测值”。实现方式：基于服务端观测（httpd access log + ws handshake log）提取 method + path + 关键请求头（Range/Content-Length 等白名单），写回 baseline/QCurl artifacts；对比时忽略用于关联的 query `id`。 | 高 | LC-2、LC-5 | 已完成 | 2025-12-16 23:24:36：开始实现服务端观测：基于 httpd access log + ws handshake JSONL 生成“请求语义摘要”，pytest driver 为 baseline/QCurl 注入独立 req_id 并写回 artifacts 的 request.method/url/headers（基于观测）。<br>2025-12-17：兼容性修复（不改 `curl/tests/...`）：`tests/libcurl_consistency/conftest.py` 不再依赖 `httpd._access_log`（不同 curl 版本不保证存在），改为 monkeypatch `Httpd.reset_config()` 注入 `CustomLog` 到 `logs/access_log`；并 monkeypatch `NghttpxQuic.start()` 增加 `--accesslog-file/--accesslog-format`，固定到 `nghttpx-quic/access_log`；`lc_logs` 指向上述稳定路径。 |
| LC-5b | P0 Gate 可靠性：补齐“响应语义摘要”的观测字段（至少 status + 实际协议 http/1.1/h2；可选关键响应头）。并增加“期望协议”自检：h2 变体实际必须为 h2（否则 fail/skip，避免伪通过）。 | 高 | LC-5a | 已完成 | 2025-12-16 23:39:50：`test_p0_consistency.py` 基于 httpd access_log 写回 response.status/http_version，并对每个变体强制校验实际协议（http/1.1/h2）。修复问题：连接池在 `QCNetworkReply.cpp` 末尾调用 `configureCurlHandle()` 覆盖 `CURLOPT_HTTP_VERSION`，导致“请求 http/1.1 实际走 h2”；已将连接池配置提前并让请求级 HTTP 版本覆盖；同时修复 baseline `cli_hx_upload` 在 POST 场景下 `-l` 未生效（改用 `CURLOPT_POSTFIELDSIZE_LARGE`）。回归：`pytest tests/libcurl_consistency/test_p0_consistency.py` 通过（7 passed，需 escalated）。 |
| LC-6 | 落地 P0：下载字节一致（覆盖 h1/h2/h3）；对齐 `test_02_download.py` 的数据断言（最终文件内容），并强制校验请求语义摘要一致。 | 高 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16：`test_p0_consistency.py` 对 download_serial/parallel 在 http/1.1+h2（h3 取决于 `env.have_h3()`）下对齐 baseline 与 QCurl（download_*.data hash/len）；`conftest.py` 自动生成 data-1m/data-10m 测试文件。 |
| LC-7 | 落地 P0：上传/回显一致（PUT/POST，覆盖 h1/h2/h3）；对齐 `test_07_upload.py` 的回显/长度断言，并强制校验请求语义摘要一致。 | 高 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16：对齐 upload_put 与 upload_post_reuse（body len/hash + 响应字节 hash/len）并覆盖 http/1.1+h2（h3 取决于 `env.have_h3()`）。<br>2025-12-16 22:58:27：upload baseline 用例追加 `-l`（announce length）使 `Content-Length` 成为实际可比字段；复跑 P0 通过。 |
| LC-8 | 落地 P0：WebSocket 基础收发一致（ping/pong + small data）；对齐 `test_20_websockets.py` 的收发断言，并强制校验握手/关键请求语义摘要一致。 | 高 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16：对齐 ws_pingpong_small 与 ws_data_small；QCurl 侧写出 download_0.data，baseline 侧用期望字节计算 hash/len；用例通过。 |
| LC-9 | 落地 P1：`CURLOPT_POSTFIELDS` 二进制（含 `\\0`）一致性；基线参考 `test1531/lib1531.c` 的断言逻辑，QCurl 侧复现相同 payload 与期望。 | 中 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16 23:39:50：新增 baseline 客户端 `curl/tests/libtest/cli_postfields_binary.c`（POSTFIELDS+POSTFIELDSIZE_LARGE，写 `download_0.data`），并在 `curl/tests/libtest/Makefile.inc` 注册；Qt 侧在 `tests/tst_LibcurlConsistency.cpp` 增加 `postfields_binary_1531` 分支（POST 二进制 payload 回显）；pytest 新增 `tests/libcurl_consistency/test_p1_postfields_binary.py`（覆盖 http/1.1+h2(+h3 若可用)，复用 LC-5a/5b 的服务端观测写回与对比）。回归：`pytest tests/libcurl_consistency/test_p1_postfields_binary.py` 通过（1 passed，需 escalated）。<br>2025-12-17：为遵守“不修改 curl/ 目录”，baseline 调整为 repo 内置可执行 `qcurl_lc_postfields_binary_baseline`（pytest baseline runner 对 `cli_postfields_binary` 特判），并通过全量 Gate（14 passed）。 |
| LC-10 | 落地 P1：cookie 文件读写一致（`COOKIEFILE/COOKIEJAR`）；基线参考 `test1903`，QCurl 侧输出 cookiejar 后做规范化对比（排序/时间戳/域名大小写等）。 | 中 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-17 00:11:39：跑通 `tests/libcurl_consistency/test_p1_cookiejar_1903.py`（baseline `lib1903` vs QCurl `cookiejar_1903`），并在对比侧规范化 cookie path 尾随斜杠差异（`/we/want` vs `/we/want/`），避免无意义不一致；回归通过（1 passed，需 escalated）。 |
| LC-11 | 可选扩展：纳入 multi/复用类用例（如 `test2402/test2502`）与 WS 低层 API（如 `test2301/test2700`），并提供单独的 suite 开关，避免波动影响 Gate。 | 低 | LC-6、LC-7、LC-8 | 已完成 | 2025-12-17：新增扩展套件开关 `QCURL_LC_EXT=1` 与用例 `ext_download_parallel_stress`（h2/h3 并发下载压力，默认不跑），pytest：`tests/libcurl_consistency/test_ext_suite.py`，Qt：`tests/tst_LibcurlConsistency.cpp`。<br>2025-12-17：修复 ext suite 运行时 Qt 进程“测试结束后不退出/卡死”的问题：根因是 `QCCurlMultiManager::~QCCurlMultiManager()` 持锁调用 `curl_multi_remove_handle/cleanup` 触发 socket 回调重入，导致死锁；修复为：析构标记 `m_isShuttingDown` + 先禁用 libcurl 回调（`CURLMOPT_SOCKETFUNCTION/TIMERFUNCTION` 置空）+ 不持锁清理 handle；并在回调/事件入口早退。回归：`QCURL_LC_EXT=1 pytest tests/libcurl_consistency/test_ext_suite.py` 通过（需 escalated）。<br>2025-12-17：回归 Gate：`pytest tests/libcurl_consistency/test_p0_consistency.py`（7 passed）与 P1（2 passed）通过。 |
| LC-12 | 可选：补充“服务端视角”观测：在可行的协议/服务端上记录语义摘要或原始报文片段，用于 debug（不作为默认 Gate/P0 断言）。 | 低 | LC-2、LC-5 | 已完成 | 2025-12-17：新增失败时可选日志收集机制：`QCURL_LC_COLLECT_LOGS=1` 时，P0/P1/ext 用例在断言失败/异常时会将 `httpd/nghttpx/ws` 关键日志复制到 `curl/tests/http/gen/artifacts/<suite>/<case>/service_logs/`，并写出 `meta.json`（含 baseline/qcurl req_id）；实现位于 `tests/libcurl_consistency/pytest_support/service_logs.py`，不记录“服务端看到的原始请求字节”。 |
| LC-13 | 落地 P0：下载“中断 + Range 续传”一致性（不包含 `cli_hx_download -P` 的 in-flight pause/resume）；断言最终文件字节一致 + Range 偏移/边界正确，并强制校验请求语义摘要一致。 | 高 | LC-6 | 已完成 | 2025-12-16：实现 `download_range_resume`（第二段用 Range start-end），并在对比侧要求服务端观测到“首段非 Range + 次段 Range”。<br>2025-12-17：全量 Gate 回归发现 curl `libtests` 中不存在 `cli_hx_range_resume`（baseline 失败：Test not found）；为避免依赖/改动 `curl/tests/...`，在 QCurl 侧新增 baseline 可执行 `qcurl_lc_range_resume_baseline`（libcurl easy API，两段请求输出 `download_0.data`），并在 `pytest_support/baseline.py` 对 `cli_hx_range_resume` 做特判调用该可执行；待回归验证。 |
| LC-14 | 文档化与复现：补齐 `README.md` 的运行方式（如何构建 curl 的 `libtests`、如何跑 pytest driver/Qt Test、失败定位路径与日志位置）。 | 中 | LC-6、LC-7、LC-8、LC-13 | 已完成 | 2025-12-16 23:39:50：更新 `tests/libcurl_consistency/README.md`：补充“服务端观测机制”（httpd access_log + ws handshake JSONL）、HTTP/3 前置条件说明，以及 P0 复现命令与默认环境变量注入。 |
| LC-15 | P2：如果后续 QCurl 提供真正的 pause/resume API，再补齐对齐 `cli_hx_download -P` 的**过程一致性**（暂停点/恢复点/回调时序/部分写入边界）。 | 低 | LC-13、（前置：QCurl pause/resume API） | 未开始 | - |
| LC-16 | 固化 P0 Gate 入口：提供统一脚本/target 完成“构建依赖 + 运行 pytest + 输出 JUnit/JSON”，并默认开启失败日志收集（`QCURL_LC_COLLECT_LOGS=1`）。 | 高 | LC-6、LC-7、LC-8、LC-13 | 已完成 | 2025-12-17：新增 Gate 脚本 `tests/libcurl_consistency/run_gate.py`（支持 `--suite p0|p1|all`、`--build`、`--with-ext`；输出 `build/libcurl_consistency/reports/junit_*.xml` 与 `gate_*.json`），并在 README 增加 Gate 使用说明。<br>2025-12-17：require_escalated 下回归验证：`python tests/libcurl_consistency/run_gate.py --suite p0 --build` 通过（`7 passed`），生成 `build/libcurl_consistency/reports/junit_p0.xml` 与 `build/libcurl_consistency/reports/gate_p0.json`。<br>2025-12-17：全量回归：`python tests/libcurl_consistency/run_gate.py --suite all --build --with-ext` 通过（`12 passed`），生成 `build/libcurl_consistency/reports/junit_all.xml` 与 `build/libcurl_consistency/reports/gate_all.json`。<br>2025-12-17：再次全量回归（含 ext WS）：`python tests/libcurl_consistency/run_gate.py --suite all --build --with-ext` 通过（`14 passed`），报告输出到 `build/libcurl_consistency/reports/junit_all.xml` 与 `build/libcurl_consistency/reports/gate_all.json`。 |
| LC-17 | 扩展 ext：落地 `test2402` 语义（HTTP/2 multi 多资源 GET）：新增 baseline libcurl client + QCurl 用例 + 观测/对比（多请求语义摘要 + 多文件字节）。 | 中 | LC-5a、LC-11 | 已完成 | 2025-12-17：新增 baseline client：`curl/tests/libtest/cli_hx_multi_get4.c`（multi + MAXCONNECTS=1，写出 `download_*.data`），并更新 `curl/tests/libtest/Makefile.inc` 触发 `libtests.c` 生成。<br>2025-12-17：新增 ext cases：`tests/libcurl_consistency/pytest_support/case_defs.py`（`ext_multi_get4_h2`），Qt 执行分支：`tests/tst_LibcurlConsistency.cpp`（并发 GET `/path/2402{0001..}` 落盘）。<br>2025-12-17：扩展观测/对比以支持“同一 case 多请求”：`tests/libcurl_consistency/pytest_support/observed.py` 增加 `*_observed_list_for_id`；`tests/libcurl_consistency/pytest_support/compare.py` 增加 `requests[]/responses[]` 对比；`tests/libcurl_consistency/test_ext_suite.py` 写入多请求语义摘要与逐文件 sha256/len。<br>2025-12-17：问题与修复：curl `libtests` 首次编译失败（static 函数名冲突 `write_cb`、使用了不存在的 `TEST_ERR_*` 常量、`abort_on_test_timeout()` 需要 `test_cleanup:` 标签、usage 字符串误用 `%04d`）；已通过函数/变量唯一前缀、改用已有 `TEST_ERR_*`、统一 `test_cleanup:` 标签、修正 usage 文案解决。<br>2025-12-17：回归：`QCURL_LC_EXT=1 pytest tests/libcurl_consistency/test_ext_suite.py` 通过（需 escalated）。<br>2025-12-17：为遵守“不修改 curl/ 目录”，新增 repo 内置 baseline 可执行 `qcurl_lc_multi_get4_baseline` 并在 pytest baseline runner 中对 `cli_hx_multi_get4` 特判；全量 Gate（`--with-ext`）通过（14 passed）。 |
| LC-18 | 扩展 ext：落地 `test2502` 语义（HTTP/3 multi 多资源 GET）：新增 baseline libcurl client + QCurl 用例 + 观测/对比（多请求语义摘要 + 多文件字节）。 | 中 | LC-2、LC-17 | 已完成 | 2025-12-17：复用 `cli_hx_multi_get4` 与 QCurl 分支，新增 `ext_multi_get4_h3`（请求 `/path/2502{0001..}`，强制 `proto=h3`，仅在 `env.have_h3()` 时启用）。回归：`QCURL_LC_EXT=1 pytest tests/libcurl_consistency/test_ext_suite.py` 通过（3 passed，需 escalated）。<br>2025-12-17：同 LC-17，multi-get4 baseline 统一使用 repo 内置 `qcurl_lc_multi_get4_baseline`（支持 h3），并通过全量 Gate（14 passed）。 |
| LC-19 | 扩展 ext：评估并落地 `test2301`（WS raw/callback + ping→pong）一致性用例：需要服务端可控发送 Ping 帧，并在 QCurl 侧可观测/可对比“Ping 帧/Close 帧”等低层事件。 | 低 | LC-8、LC-11 | 已完成 | 2025-12-17：在 `tests/libcurl_consistency/` 自建 WS 场景服务端 `ws_scenario_server.py`：`scenario=lc_ping`（server Ping(空 payload) → wait Pong → Close(1000,\"done\")），输出 `ws_handshake.jsonl`（语义摘要）+ `ws_events.jsonl`（debug）。<br>2025-12-17：新增 baseline WS 客户端 `ws_baseline_client.cpp`（target `qcurl_lc_ws_baseline`，`CURLOPT_CONNECT_ONLY=2` + `CURLWS_NOAUTOPONG`，收到 Ping 手动回 Pong，输出事件序列到 `download_0.data`）。<br>2025-12-17：补齐 QCurl WS 低层可观测与控制：`QCWebSocket::pong()`、`setAutoPongEnabled()`、`pingReceived()`、`closeReceived()`；并修复 `curl_ws_recv()` 在 Ping(0 bytes) 时 `received==0` 仍需处理 meta 的问题。<br>2025-12-17：新增 Qt Test case `ext_ws_ping_2301` 与 pytest `test_ext_ws_suite.py` 对比 baseline/QCurl；回归：`QCURL_LC_EXT=1 pytest tests/libcurl_consistency/test_ext_ws_suite.py -k ext_ws_ping_2301` 通过（需 escalated）。<br>问题与解决：握手头 `Sec-WebSocket-Key` 不可比 → 从 handshake allowlist 排除。 |
| LC-20 | 扩展 ext：评估并落地 `test2700`（WS 帧类型：text/binary/ping/pong/close）一致性用例：需要服务端发送指定帧序列，且 QCurl 侧能稳定观测并序列化这些事件用于对比。 | 低 | LC-19 | 已完成 | 2025-12-17：扩展 WS 场景服务端：`scenario=lc_frame_types`（TEXT(\"txt\") → BINARY(\"bin\") → Ping(\"ping\") → Pong(\"pong\") → Close(1000,\"close\")）；Qt Test 新增 `ext_ws_frame_types_2700` 序列化 TEXT/BINARY/PING/PONG/CLOSE 事件到 `download_0.data`；回归：`QCURL_LC_EXT=1 pytest tests/libcurl_consistency/test_ext_ws_suite.py -k ext_ws_frame_types_2700` 通过（需 escalated）。 |
| LC-21 | 补齐 P1：本地 HTTP proxy 一致性（含 CONNECT 隧道）。自建 proxy 记录可观测数据：method/target + Proxy-*（Proxy-Authorization），并对比 baseline/QCurl 在 proxy 视角下的一致性；HTTPS 场景同时对齐 origin 侧请求语义摘要与响应字节。 | 中 | LC-5a、LC-4、LC-5 | 已完成 | 2025-12-21：新增 `tests/libcurl_consistency/http_proxy_server.py`（Basic auth + CONNECT + JSONL 观测）与 pytest fixture `lc_http_proxy`；新增 repo 内置 baseline 可执行 `qcurl_lc_http_baseline`（支持 proxy/cookiefile）；新增用例 `tests/libcurl_consistency/test_p1_proxy.py`（HTTP proxy + HTTPS CONNECT 两个 case），Qt 执行器 `tests/tst_LibcurlConsistency.cpp` 新增 `proxy_http_basic_auth`/`proxy_https_connect_basic_auth` 分支；`tests/libcurl_consistency/run_gate.py` 将 proxy 用例纳入 P1/all；回归：`pytest tests/libcurl_consistency/test_p1_proxy.py` 通过（2 passed，需 escalated）。<br>2025-12-22 01:03:23：复跑 `pytest tests/libcurl_consistency/test_p1_proxy.py` 通过（2 passed，需 escalated）。 |
| LC-22 | 补齐 P2：Cookie 请求头可观测一致性（与 cookiejar 文件落盘测试解耦）。自建观测 HTTP 服务端记录 `Cookie:`，对齐 baseline/QCurl 在相同 cookiefile 输入下服务端看到的 Cookie 值（做稳定归一化）。 | 低 | LC-5a、LC-4、LC-5 | 已完成 | 2025-12-21：新增 `tests/libcurl_consistency/http_observe_server.py`（/cookie + JSONL 观测）与 pytest fixture `lc_observe_http`；新增用例 `tests/libcurl_consistency/test_p2_cookie_request_header.py`；Qt 执行器 `tests/tst_LibcurlConsistency.cpp` 新增 `p2_cookie_request_header` 分支；回归：`pytest tests/libcurl_consistency/test_p2_cookie_request_header.py` 通过（1 passed，需 escalated）。<br>2025-12-22 01:03:23：复跑 `pytest tests/libcurl_consistency/test_p2_cookie_request_header.py` 通过（1 passed，需 escalated）。 |
| LC-23 | 补齐 P2：固定 HTTP 错误码（404/401/503）一致性。自建观测 HTTP 服务端返回固定状态与 body；两侧记录“错误字段归一化”（kind/http_status）并对比，同时对比响应字节 hash/len。 | 低 | LC-22 | 已完成 | 2025-12-21：复用 `http_observe_server.py` 的 `/status/<code>`；新增用例 `tests/libcurl_consistency/test_p2_fixed_http_errors.py`；Qt 执行器 `tests/tst_LibcurlConsistency.cpp` 新增 `p2_fixed_http_error` 分支（断言 QCurl 对 HTTP>=400 视为 error 且仍可读 body）；对比器 `tests/libcurl_consistency/pytest_support/compare.py` 增加可选 `error(kind/http_status)` 对比；回归：`pytest tests/libcurl_consistency/test_p2_fixed_http_errors.py` 通过（3 passed，需 escalated）。<br>2025-12-22 01:03:23：复跑 `pytest tests/libcurl_consistency/test_p2_fixed_http_errors.py` 通过（3 passed，需 escalated）。 |
| LC-24 | 补齐 P1：重定向（FOLLOWLOCATION）与“模拟 HTTP 登录态”一致性：多跳 302 的请求序列一致、最终落点一致；可观测对比关键响应头 `Location`/`Set-Cookie` 与关键请求头 `Host`/`Cookie`。 | 中 | LC-5、LC-21、LC-22 | 已完成 | 2025-12-22：扩展 `tests/libcurl_consistency/http_observe_server.py` 支持 `/redir/<n>`、`/login`、`/home` 并输出 `response_headers`；新增用例 `tests/libcurl_consistency/test_p1_redirect_and_login_flow.py`（follow on/off + login cookie flow）；Qt 执行器 `tests/tst_LibcurlConsistency.cpp` 新增 `p1_redirect_{no}follow` 与 `p1_login_cookie_flow` 分支；回归：`pytest tests/libcurl_consistency/test_p1_redirect_and_login_flow.py` 通过（3 passed，需 escalated）。 |
| LC-25 | 补齐 P2：TLS 校验语义一致性（成功/失败路径）：对齐 verifyPeer/verifyHost + CAINFO/caCertPath 下的可观测结果（成功/证书错误）。 | 低 | LC-24 | 已完成 | 2025-12-22：新增 fixture `lc_observe_https`（复用 curl testenv 生成的 CA 与 `localhost` 证书）与用例 `tests/libcurl_consistency/test_p2_tls_verify.py`（成功 with CA、失败 no CA）；扩展 baseline `qcurl_lc_http_baseline` 支持 `--secure/--cainfo`；Qt 执行器 `tests/tst_LibcurlConsistency.cpp` 新增 `p2_tls_verify_success`/`p2_tls_verify_fail_no_ca` 分支；并在 baseline runner 支持 `allowed_exit_codes` 以记录期望失败；回归：`pytest tests/libcurl_consistency/test_p2_tls_verify.py` 通过（2 passed，需 escalated）。 |

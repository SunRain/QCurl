# 计划任务列表（由 README 拆分）

> 目标：落地 “QCurl ↔ libcurl（含 libtest 工具）数据一致性测试候选集”，采用 **Qt Test（C++）+ pytest（Python）混合** 的方式实现与编排。

| ID | 任务描述 | 优先级 | 依赖关系 | 状态 | 执行日志 |
|---|---|---|---|---|---|
| LC-0 | 明确“一致性”的可观测断言与 `artifacts` 最小字段（下载/上传/WS：status、协议族(h1/h2/h3)、body 长度+hash、关键响应头；**P0 必做：请求语义摘要**（method/url/关键头规范化）+ request body 的 len/hash；不强制记录“服务端看到的原始请求字节”；错误码/超时归一化规则）。 | 高 | 无 | 已完成 | 2025-12-16：已在 README 固化字段，确认请求语义摘要为 P0 必做，不记录服务端原始字节。 |
| LC-1 | 固化候选集清单与边界：把 `README.md` 中 **P0/P1/可选扩展/明确排除** 转成可执行清单（可先用静态列表；如需参数化再引入 manifest）。 | 高 | LC-0 | 已完成 | 2025-12-16：已转成本表，覆盖 P0/P1/扩展/排除清单。 |
| LC-2 | 编写 pytest 驱动骨架：复用 `curl/tests/http/testenv` 启动服务端（http/1.1 + h2 + h3 + ws），提供统一的 “启动/停止/日志收集/端口分配” 封装。 | 高 | LC-0 | 已完成 | 2025-12-16：新增 `tests/libcurl_consistency/conftest.py` 复用 testenv（注入 CURL_BUILD_DIR/CURL/CURLINFO），并生成 `curl/tests/http/config.ini`；新增 `test_env_smoke.py` 验证 httpd/nghttpx/ws 可启动（受 sandbox 限制需 escalated）。<br>2025-12-16 22:50:45：复跑 `pytest tests/libcurl_consistency/test_env_smoke.py` 通过；sandbox 下端口分配触发 `PermissionError`，需 escalated。<br>2025-12-17 00:11:39：修复 curl testenv `httpd.py` 生成配置中 `TypesConfig` 引号缺失，复跑 smoke 通过。 |
| LC-3 | 在 pytest 中跑 **libcurl baseline**：通过 `LocalClient(name='cli_*')` 调用 `curl/tests/libtest/libtests`，生成 baseline `artifacts`（每条用例一份 JSON）。 | 高 | LC-1、LC-2 | 已完成 | 2025-12-16：完善 `pytest_support/baseline.py`（hash/len、请求语义摘要）；补齐 `case_defs.py` P0 参数模板；新增 `curl/tests/libtest/cli_hx_range_resume.c` 并更新 `curl/tests/libtest/Makefile.inc`，重建 `curl/build/tests/libtest/libtests`。<br>2025-12-16 22:50:45：`cmake --build \"curl/build\" --target libtests` 构建通过。<br>2025-12-16 22:58:27：为“请求语义摘要”补齐可比字段：上传 baseline 用例参数追加 `-l` 强制 Content-Length；Range 续传 baseline 支持 `-S` 并用 `CURLOPT_RANGE` 显式 end，已重建 `libtests` 并复跑 P0 通过。 |
| LC-4 | 新增 Qt Test（C++）：实现与 P0/P1 对齐的 QCurl 客户端场景（下载/上传/WS），将结果写出为 QCurl `artifacts`（JSON，字段与 LC-0 一致）。 | 高 | LC-0、LC-2 | 已完成 | 2025-12-16：新增 `tests/tst_LibcurlConsistency.cpp`（按 env vars 执行单用例并落盘 download_*.data），并在 `tests/CMakeLists.txt` 注册生成 `build/tests/tst_LibcurlConsistency`；`pytest_support/qcurl_runner.py` 负责运行与写出 QCurl artifacts。<br>2025-12-16 22:50:45：`cmake --build \"build\" --target tst_LibcurlConsistency` 构建通过。 |
| LC-5 | 实现对比器（pytest 侧）：读取 baseline/QCurl `artifacts`，做字节级（hash/len）与关键语义字段对比（**P0 必做：请求语义摘要一致性**），输出可机器消费的报告（JSON/JUnit 二选一或同时）。 | 高 | LC-0、LC-3、LC-4 | 已完成 | 2025-12-16：新增 `pytest_support/compare.py`（compare + assert helper），并在 `test_p0_consistency.py` 接线执行。<br>2025-12-16 22:50:45：`QCURL_QTTEST=\"build/tests/tst_LibcurlConsistency\" pytest tests/libcurl_consistency/test_p0_consistency.py` 通过（7 passed）；artifacts 输出在 `curl/tests/http/gen/artifacts/`（sandbox 下需 escalated 启动服务端）。 |
| LC-5a | P0 Gate 可靠性：将“请求语义摘要”从“构造值”升级为“观测值”。实现方式：基于服务端观测（httpd access log + ws handshake log）提取 method + path + 关键请求头（Range/Content-Length 等白名单），写回 baseline/QCurl artifacts；对比时忽略用于关联的 query `id`。 | 高 | LC-2、LC-5 | 已完成 | 2025-12-16 23:24:36：开始实现服务端观测：新增 httpd access log（结构化/可解析），并在 ws echo server 增加 handshake 记录；随后对接 pytest driver 写回 artifacts。<br>2025-12-16 23:39:50：新增/修改：`curl/tests/http/testenv/httpd.py` 写出 `access_log`（LogFormat 含 method/url/status/proto/Range/Content-Length）；`curl/tests/http/testenv/ws_echo_server.py` 追加 `--log-file` 输出握手 JSONL；`tests/libcurl_consistency/conftest.py` 注入 `httpd_access_log/ws_handshake_log`；新增 `tests/libcurl_consistency/pytest_support/observed.py`；`tests/libcurl_consistency/test_p0_consistency.py` 为每次 baseline/QCurl 生成独立 req_id 并写回 artifacts 的 request.method/url/headers（基于观测）。 |
| LC-5b | P0 Gate 可靠性：补齐“响应语义摘要”的观测字段（至少 status + 实际协议 http/1.1/h2；可选关键响应头）。并增加“期望协议”自检：h2 变体实际必须为 h2（否则 fail/skip，避免伪通过）。 | 高 | LC-5a | 已完成 | 2025-12-16 23:39:50：`test_p0_consistency.py` 基于 httpd access_log 写回 response.status/http_version，并对每个变体强制校验实际协议（http/1.1/h2）。修复问题：连接池在 `QCNetworkReply.cpp` 末尾调用 `configureCurlHandle()` 覆盖 `CURLOPT_HTTP_VERSION`，导致“请求 http/1.1 实际走 h2”；已将连接池配置提前并让请求级 HTTP 版本覆盖；同时修复 baseline `cli_hx_upload` 在 POST 场景下 `-l` 未生效（改用 `CURLOPT_POSTFIELDSIZE_LARGE`）。回归：`pytest tests/libcurl_consistency/test_p0_consistency.py` 通过（7 passed，需 escalated）。 |
| LC-6 | 落地 P0：下载字节一致（覆盖 h1/h2/h3）；对齐 `test_02_download.py` 的数据断言（最终文件内容），并强制校验请求语义摘要一致。 | 高 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16：`test_p0_consistency.py` 对 download_serial/parallel 在 http/1.1+h2（h3 取决于 `env.have_h3()`）下对齐 baseline 与 QCurl（download_*.data hash/len）；`conftest.py` 自动生成 data-1m/data-10m 测试文件。 |
| LC-7 | 落地 P0：上传/回显一致（PUT/POST，覆盖 h1/h2/h3）；对齐 `test_07_upload.py` 的回显/长度断言，并强制校验请求语义摘要一致。 | 高 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16：对齐 upload_put 与 upload_post_reuse（body len/hash + 响应字节 hash/len）并覆盖 http/1.1+h2（h3 取决于 `env.have_h3()`）。<br>2025-12-16 22:58:27：upload baseline 用例追加 `-l`（announce length）使 `Content-Length` 成为实际可比字段；复跑 P0 通过。 |
| LC-8 | 落地 P0：WebSocket 基础收发一致（ping/pong + small data）；对齐 `test_20_websockets.py` 的收发断言，并强制校验握手/关键请求语义摘要一致。 | 高 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16：对齐 ws_pingpong_small 与 ws_data_small；QCurl 侧写出 download_0.data，baseline 侧用期望字节计算 hash/len；用例通过。 |
| LC-9 | 落地 P1：`CURLOPT_POSTFIELDS` 二进制（含 `\\0`）一致性；基线参考 `test1531/lib1531.c` 的断言逻辑，QCurl 侧复现相同 payload 与期望。 | 中 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-16 23:39:50：新增 baseline 客户端 `curl/tests/libtest/cli_postfields_binary.c`（POSTFIELDS+POSTFIELDSIZE_LARGE，写 `download_0.data`），并在 `curl/tests/libtest/Makefile.inc` 注册；Qt 侧在 `tests/tst_LibcurlConsistency.cpp` 增加 `postfields_binary_1531` 分支（POST 二进制 payload 回显）；pytest 新增 `tests/libcurl_consistency/test_p1_postfields_binary.py`（覆盖 http/1.1+h2(+h3 若可用)，复用 LC-5a/5b 的服务端观测写回与对比）。回归：`pytest tests/libcurl_consistency/test_p1_postfields_binary.py` 通过（1 passed，需 escalated）。 |
| LC-10 | 落地 P1：cookie 文件读写一致（`COOKIEFILE/COOKIEJAR`）；基线参考 `test1903`，QCurl 侧输出 cookiejar 后做规范化对比（排序/时间戳/域名大小写等）。 | 中 | LC-3、LC-4、LC-5 | 已完成 | 2025-12-17 00:11:39：跑通 `tests/libcurl_consistency/test_p1_cookiejar_1903.py`（baseline `lib1903` vs QCurl `cookiejar_1903`），并在对比侧规范化 cookie path 尾随斜杠差异（`/we/want` vs `/we/want/`），避免无意义不一致；回归通过（1 passed，需 escalated）。 |
| LC-11 | 可选扩展：纳入 multi/复用类用例（如 `test2402/test2502`）与 WS 低层 API（如 `test2301/test2700`），并提供单独的 suite 开关，避免波动影响 Gate。 | 低 | LC-6、LC-7、LC-8 | 未开始 | - |
| LC-12 | 可选：补充“服务端视角”观测：在可行的协议/服务端上记录语义摘要或原始报文片段，用于 debug（不作为默认 Gate/P0 断言）。 | 低 | LC-2、LC-5 | 未开始 | - |
| LC-13 | 落地 P0：下载“中断 + Range 续传”一致性（不包含 `cli_hx_download -P` 的 in-flight pause/resume）；断言最终文件字节一致 + Range 偏移/边界正确，并强制校验请求语义摘要一致。 | 高 | LC-6 | 已完成 | 2025-12-16：新增 baseline `cli_hx_range_resume`（abort 后用 RESUME_FROM_LARGE 续传）与 QCurl `download_range_resume`（第二段用 Range start-end）；请求语义摘要包含 Range，最终文件大小与 hash 对齐。<br>2025-12-16 22:58:27：baseline `cli_hx_range_resume` 增加 `-S file_size`，phase2 优先用 `CURLOPT_RANGE` 发送显式 `bytes=start-end`（语义摘要与实际请求头一致）；复跑 P0 通过。 |
| LC-14 | 文档化与复现：补齐 `README.md` 的运行方式（如何构建 curl 的 `libtests`、如何跑 pytest driver/Qt Test、失败定位路径与日志位置）。 | 中 | LC-6、LC-7、LC-8、LC-13 | 已完成 | 2025-12-16 23:39:50：更新 `tests/libcurl_consistency/README.md`：补充“服务端观测机制”（httpd access_log + ws handshake JSONL）、HTTP/3 前置条件说明，以及 P0 复现命令与默认环境变量注入。 |
| LC-15 | P2：如果后续 QCurl 提供真正的 pause/resume API，再补齐对齐 `cli_hx_download -P` 的**过程一致性**（暂停点/恢复点/回调时序/部分写入边界）。 | 低 | LC-13、（前置：QCurl pause/resume API） | 未开始 | - |

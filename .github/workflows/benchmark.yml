# QCurl æ€§èƒ½åŸºå‡† CI/CD å·¥ä½œæµ
# åœ¨ PR å’Œä¸»åˆ†æ”¯æ¨é€æ—¶è‡ªåŠ¨è¿è¡Œæ€§èƒ½æµ‹è¯•ï¼Œæ£€æµ‹æ€§èƒ½å›å½’

name: Performance Benchmarks

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'src/**'
      - 'benchmarks/**'
      - '.github/workflows/benchmark.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'src/**'
      - 'benchmarks/**'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Benchmark iterations'
        required: false
        default: '100'

env:
  BUILD_TYPE: Release
  BENCHMARK_ITERATIONS: ${{ github.event.inputs.iterations || '100' }}

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      # HTTP æµ‹è¯•æœåŠ¡å™¨
      httpbin:
        image: kennethreitz/httpbin
        ports:
          - 8935:80

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²ç”¨äºåŸºå‡†å¯¹æ¯”

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          ninja-build \
          qt6-base-dev \
          libcurl4-openssl-dev \
          libssl-dev \
          zlib1g-dev

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DBUILD_TESTING=OFF \
          -DBUILD_BENCHMARKS=ON \
          -DBUILD_EXAMPLES=OFF

    - name: Build benchmarks
      run: cmake --build build --parallel

    - name: Run benchmarks
      id: run_benchmarks
      run: |
        # åˆ›å»ºç»“æœç›®å½•
        mkdir -p benchmark-results

        # è¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•å¹¶æ”¶é›†ç»“æœ
        for bench in build/benchmarks/benchmark_*; do
          if [ -x "$bench" ]; then
            name=$(basename "$bench")
            echo "Running $name..."

            # è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œæ•è·è¾“å‡º
            timeout 300 "$bench" -iterations ${{ env.BENCHMARK_ITERATIONS }} \
              -o benchmark-results/${name}.txt \
              2>&1 || true
          fi
        done

    - name: Parse benchmark results
      id: parse_results
      run: |
        python3 scripts/parse_benchmark_results.py \
          benchmark-results/ \
          --output benchmark-results/summary.json

        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "results_file=benchmark-results/summary.json" >> $GITHUB_OUTPUT

    - name: Download baseline (if exists)
      id: download_baseline
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: benchmark-baseline
        path: benchmark-baseline/

    - name: Compare with baseline
      id: compare
      if: steps.download_baseline.outcome == 'success'
      run: |
        python3 scripts/compare_benchmarks.py \
          benchmark-baseline/summary.json \
          benchmark-results/summary.json \
          --threshold 10 \
          --output benchmark-results/comparison.md

        # æ£€æŸ¥æ˜¯å¦æœ‰æ€§èƒ½å›å½’
        if grep -q "REGRESSION DETECTED" benchmark-results/comparison.md; then
          echo "regression=true" >> $GITHUB_OUTPUT
        else
          echo "regression=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-${{ github.sha }}
        path: benchmark-results/
        retention-days: 90

    - name: Update baseline (on main branch)
      if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-baseline
        path: benchmark-results/summary.json
        retention-days: 90

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          let body = '## ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ\n\n';

          // è¯»å–æ¯”è¾ƒç»“æœ
          if (fs.existsSync('benchmark-results/comparison.md')) {
            body += fs.readFileSync('benchmark-results/comparison.md', 'utf8');
          } else {
            body += '> â„¹ï¸ æ²¡æœ‰å¯ç”¨çš„åŸºçº¿æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼ˆé¦–æ¬¡è¿è¡Œï¼‰\n\n';

            // è¯»å–å½“å‰ç»“æœæ‘˜è¦
            if (fs.existsSync('benchmark-results/summary.json')) {
              const summary = JSON.parse(fs.readFileSync('benchmark-results/summary.json', 'utf8'));
              body += '### å½“å‰æµ‹è¯•ç»“æœ\n\n';
              body += '| åŸºå‡†æµ‹è¯• | æŒ‡æ ‡ | å€¼ |\n';
              body += '|---------|------|----|\n';

              for (const [test, metrics] of Object.entries(summary)) {
                for (const [metric, value] of Object.entries(metrics)) {
                  body += `| ${test} | ${metric} | ${value} |\n`;
                }
              }
            }
          }

          body += '\n---\n';
          body += `ğŸ“ æäº¤: \`${context.sha.substring(0, 7)}\` | `;
          body += `âš™ï¸ è¿­ä»£æ¬¡æ•°: ${process.env.BENCHMARK_ITERATIONS}`;

          // åˆ›å»ºæˆ–æ›´æ–°è¯„è®º
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(c =>
            c.user.type === 'Bot' &&
            c.body.includes('æ€§èƒ½åŸºå‡†æµ‹è¯•ç»“æœ')
          );

          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body,
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body,
            });
          }

    - name: Fail on regression
      if: steps.compare.outputs.regression == 'true'
      run: |
        echo "âŒ æ£€æµ‹åˆ°æ€§èƒ½å›å½’ï¼è¯·æŸ¥çœ‹æ¯”è¾ƒæŠ¥å‘Šã€‚"
        cat benchmark-results/comparison.md
        exit 1
